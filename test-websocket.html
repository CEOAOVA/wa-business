<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test WebSocket Connection</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    #status {
      padding: 10px;
      border-radius: 5px;
      margin: 20px 0;
      font-weight: bold;
    }
    #status.connected { background: #4CAF50; color: white; }
    #status.disconnected { background: #f44336; color: white; }
    #status.connecting { background: #FF9800; color: white; }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #2196F3;
      color: white;
    }
    button:hover { background: #1976D2; }
    #log {
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-entry {
      padding: 5px;
      margin: 2px 0;
      border-left: 3px solid #2196F3;
      padding-left: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-success { border-left-color: #4CAF50; }
    .log-error { border-left-color: #f44336; }
    .log-warning { border-left-color: #FF9800; }
    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>üîå Test de Conexi√≥n WebSocket</h1>
  
  <div id="status" class="disconnected">Desconectado</div>
  
  <div>
    <input type="text" id="tokenInput" placeholder="Pega tu token de autenticaci√≥n aqu√≠..." />
    <input type="text" id="backendUrl" value="https://dev-apiwaprueba.aova.mx" placeholder="URL del backend" />
  </div>
  
  <div>
    <button onclick="testConnection()">üöÄ Probar Conexi√≥n</button>
    <button onclick="disconnect()">üîå Desconectar</button>
    <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
    <button onclick="testFromLocalStorage()">üíæ Usar Token de LocalStorage</button>
  </div>
  
  <div id="log"></div>
  
  <script>
    let socket = null;
    
    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `[${timestamp}] ${msg}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus(status, text) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = status;
      statusDiv.innerText = text;
    }
    
    function testConnection() {
      const token = document.getElementById('tokenInput').value;
      const backendUrl = document.getElementById('backendUrl').value;
      
      if (!token) {
        log('‚ùå Por favor ingresa un token', 'error');
        return;
      }
      
      if (socket) {
        socket.disconnect();
        socket = null;
      }
      
      log('üîÑ Iniciando conexi√≥n...', 'warning');
      updateStatus('connecting', 'Conectando...');
      
      log(`üìç Backend URL: ${backendUrl}`, 'info');
      log(`üîë Token: ${token.substring(0, 30)}...`, 'info');
      
      socket = io(backendUrl, {
        transports: ['websocket'],
        auth: { token },
        withCredentials: true,
        timeout: 20000
      });
      
      socket.on('connect', () => {
        log(`‚úÖ CONECTADO - Socket ID: ${socket.id}`, 'success');
        updateStatus('connected', `Conectado: ${socket.id}`);
        
        // Intentar unirse a una conversaci√≥n de prueba
        socket.emit('join_conversation', 'test-conversation');
      });
      
      socket.on('connect_error', (error) => {
        log(`‚ùå ERROR DE CONEXI√ìN: ${error.message}`, 'error');
        log(`   Tipo: ${error.type}`, 'error');
        if (error.data) {
          log(`   Data: ${JSON.stringify(error.data)}`, 'error');
        }
        updateStatus('disconnected', `Error: ${error.message}`);
      });
      
      socket.on('disconnect', (reason) => {
        log(`‚ö†Ô∏è Desconectado: ${reason}`, 'warning');
        updateStatus('disconnected', 'Desconectado');
      });
      
      socket.on('new_message', (data) => {
        log(`üì® MENSAJE RECIBIDO: ${JSON.stringify(data)}`, 'success');
      });
      
      socket.on('conversation_updated', (data) => {
        log(`üìù CONVERSACI√ìN ACTUALIZADA: ${JSON.stringify(data)}`, 'success');
      });
      
      socket.on('joined_conversation', (data) => {
        log(`‚úÖ Unido a conversaci√≥n: ${JSON.stringify(data)}`, 'success');
      });
      
      socket.on('pong', (data) => {
        log(`üíì Heartbeat recibido`, 'info');
      });
      
      // Enviar ping cada 5 segundos
      setInterval(() => {
        if (socket && socket.connected) {
          socket.emit('ping', { timestamp: Date.now() });
        }
      }, 5000);
    }
    
    function disconnect() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('üîå Desconectado manualmente', 'warning');
      }
    }
    
    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('üìã Log limpiado', 'info');
    }
    
    function testFromLocalStorage() {
      try {
        // Intentar obtener token de localStorage (si est√° en el mismo dominio)
        const token = localStorage.getItem('authToken');
        if (token) {
          document.getElementById('tokenInput').value = token;
          log('‚úÖ Token obtenido de localStorage', 'success');
          testConnection();
        } else {
          log('‚ùå No hay token en localStorage', 'error');
        }
      } catch (error) {
        log('‚ùå No se puede acceder a localStorage (probablemente diferente dominio)', 'error');
      }
    }
    
    // Log inicial
    log('üöÄ Herramienta de prueba WebSocket lista', 'info');
    log('Ingresa tu token y presiona "Probar Conexi√≥n"', 'info');
    
    // Detectar si estamos en desarrollo o producci√≥n
    if (window.location.hostname === 'localhost') {
      document.getElementById('backendUrl').value = 'http://localhost:3001';
      log('üìç Detectado entorno local', 'info');
    }
  </script>
</body>
</html>